// Copyright 2022 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include "hybrid_rcc/stats/distributions/multivariate/continuous/gaussian.h"

#include <math.h>

#include <algorithm>
#include <array>
#include <cmath>
#include <complex>
#include <cstdint>
#include <numeric>
#include <random>
#include <utility>
#include <vector>

#include "hybrid_rcc/stats/statistical_tests/kolmogorov_smirnov.h"
#include "testing/base/public/gmock.h"
#include "testing/base/public/gunit.h"
#include "pcg_random/include/pcg_random.hpp"

class GaussianTest : public ::testing::Test {
 protected:
  GaussianTest() {}

  ~GaussianTest() override {}

  void SetUp() override {}

  void TearDown() override {}
};

TEST_F(GaussianTest, PDF) {
  std::vector<std::array<Eigen::ArrayXd, 4>> tests{
      std::array<Eigen::ArrayXd, 4>({
          Eigen::ArrayXd{{0.25330232072667835, -0.5810752474581407,
                          0.4193234152171857, -0.5605259164456273,
                          1.2604356503220835, 0.043054772373413354,
                          -2.6145772124036895, -0.9784632799002942,
                          0.4747244271156488, -0.26044389557640363}},
          Eigen::ArrayXd{{-0.8899518314300903, -2.4375936299865706,
                          -0.08492383825829136, -0.8831995526207206,
                          0.18378043968932584, -1.129415569361523,
                          -0.02837250181973601, 1.6164352441018535,
                          -0.1846919394052537, 0.445020244888626}},
          Eigen::ArrayXd{{0.2392063282606547, 0.10387697227725928,
                          0.09377033816258806, 1.7721099591823173,
                          1.223080873193922, 1.0385368574760807,
                          0.5369439838648985, 0.26489216162458945,
                          0.970396595539162, 1.213978100876403}},
          Eigen::ArrayXd{{1.8280591781660975e-05, 1.6732643003980243e-69,
                          2.236434213557814e-06, 0.2214215767599463,
                          0.2214055722715615, 0.20310527704292855,
                          6.8139481452575486e-06, 2.1867612112791966e-21,
                          0.32635466736690516, 0.2775677955734867}},
      }),
  };
  for (auto [x, mu, std, want] : tests) {
    Eigen::ArrayXd got =
        stats::multivariates::IndependentGaussian(mu, std).pdf(x);
    EXPECT_THAT((got - want).abs().maxCoeff(), testing::DoubleNear(0, 1e-12));
  }
}
TEST_F(GaussianTest, VECPDF) {
  std::vector<
      std::pair<std::array<Eigen::ArrayXd, 2>, std::array<Eigen::ArrayXXd, 2>>>
      tests{
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-1.7103062942294507, -1.716064098300679,
                                  6.402530540906387, -7.680263957988589,
                                  -4.020510770408912, -3.904215895378364,
                                  -4.690005917453478, 5.800963477438673,
                                  0.19173240302784933}},
                  Eigen::ArrayXd{{0.8699978965814119, 0.07670143113334216,
                                  0.4627251646620222, 0.9570066521439576,
                                  0.40175291200332486, 0.7693691637855942,
                                  0.5451069735456672, 0.2091255842067915,
                                  0.0778885423872866}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-1.5585460906815007, -1.7503633743755496,
                                    6.466263869400677, -7.890425453154885,
                                    -4.17803277405953, -3.6158826273878293,
                                    -4.481227882814776, 5.858757456064997,
                                    0.19047351782790478},
                                   {-2.111517001958209, -1.7340561464946112,
                                    6.3341839061316945, -7.8075181542504675,
                                    -4.114275119469093, -3.672226355264332,
                                    -4.7073394263590975, 5.838289796127166,
                                    0.22891580744248058},
                                   {-1.4580264992607042, -1.7168843835110303,
                                    6.325498388553404, -7.326609865172252,
                                    -3.8579476215423014, -3.9758545986050087,
                                    -4.882361776850502, 5.828559462882013,
                                    0.19526603554383976},
                                   {-1.5727340789790873, -1.7032253666861255,
                                    6.270100139457355, -7.4391111115538,
                                    -4.1497153645146545, -3.6237033794729068,
                                    -4.477440284238644, 5.7938532604310105,
                                    0.22557595840484077}},
                   Eigen::ArrayXXd{{0.45163169837117006, 4.706345996669171,
                                    0.854018891709886, 0.40693316243721933,
                                    0.9195355929030472, 0.4833670980768384,
                                    0.6801028369738207, 1.8361928514130554,
                                    5.121294653695761},
                                   {0.4122976931642753, 5.06008987265828,
                                    0.8528045762287652, 0.4131955757399517,
                                    0.9663245676250993, 0.4954865920529195,
                                    0.7314906216792518, 1.8775221185381379,
                                    4.570333118815116},
                                   {0.43967585501749473, 5.200939031808864,
                                    0.850293673410255, 0.38935092600614485,
                                    0.9149506889357002, 0.516288669362805,
                                    0.6876835561116648, 1.8911312880598647,
                                    5.116695219493937},
                                   {0.45285807797456334, 5.128880314543421,
                                    0.8275623705545849, 0.4038376983906504,
                                    0.9429571159087327, 0.48518695343098905,
                                    0.6782789474156102, 1.9065661589383627,
                                    4.660567734085475}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{0.38210537161640623, -2.622193118001235,
                                  -8.412610696979964, 2.0270668034748365,
                                  4.5953205420409144}},
                  Eigen::ArrayXd{{0.13600731234654784, 0.8020058582110072,
                                  0.7071569921360084, 0.4285141545487946,
                                  0.36420815325195055}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{0.34000638789501597, -2.2960172794392255,
                                    -8.461696926120608, 2.0507549657783404,
                                    4.535757616136808},
                                   {0.37507574198330074, -2.543404054729921,
                                    -8.667285441837727, 2.1798057413659624,
                                    4.543314852025373},
                                   {0.4293100603804343, -2.6832942323019875,
                                    -8.1788176971804, 2.1916020112205996,
                                    4.557033733040164}},
                   Eigen::ArrayXXd{{2.796034676525583, 0.45794708339739454,
                                    0.5627920581551867, 0.9295683403196665,
                                    1.0808182362841172},
                                   {2.9293260800798397, 0.49503603736022883,
                                    0.5287254579726989, 0.8736886322321973,
                                    1.0842587134168538},
                                   {2.76178633139912, 0.4959891279343168,
                                    0.5341453134872773, 0.8648300412864817,
                                    1.0893331549769156}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{5.179569012543167, -1.7131183026963832,
                                  -4.342526692012702, 10.965440239685591,
                                  1.9393778965091393, -4.133950154542898,
                                  -4.704041819763022, 5.25604688725503,
                                  5.616011521684042}},
                  Eigen::ArrayXd{{0.013509284557149837, 0.2647343490164883,
                                  0.29799107940259206, 0.5986030953484324,
                                  0.8920299102299334, 0.09019660696714704,
                                  0.48358421316720057, 0.40632279184920794,
                                  0.6236997874957313}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{5.175310698258331, -1.6777536912079978,
                                    -4.466474289278132, 10.746284448298933,
                                    2.194104169611948, -4.138647940170635,
                                    -4.5960228235993865, 5.282250233498445,
                                    5.763934811427234},
                                   {5.1749503229019, -1.6624299129536848,
                                    -4.375541061987361, 11.088409705968965,
                                    2.114573791980587, -4.146801776012863,
                                    -4.671032685577396, 5.295049310902759,
                                    5.436460521073471},
                                   {5.179647288516721, -1.8079319184191622,
                                    -4.484455065111465, 10.713681693101787,
                                    2.3170321418450266, -4.113148906394696,
                                    -4.509865426438064, 5.432516585705722,
                                    5.8601591512646785}},
                   Eigen::ArrayXXd{{28.099721072888414, 1.493567219864944,
                                    1.2278301367030862, 0.6232540689383451,
                                    0.42936212483259345, 4.417034631138833,
                                    0.8046433271590007, 0.9797963190396934,
                                    0.6218991374505491},
                                   {27.85451737502407, 1.479582144044183,
                                    1.3305814212002056, 0.6525404005891624,
                                    0.4386867532447336, 4.378359080509864,
                                    0.8230499429983807, 0.9773230041775715,
                                    0.6136748904913378},
                                   {29.53047453348969, 1.4133397336223723,
                                    1.1952196625531395, 0.6100438595639662,
                                    0.4088929551126875, 4.306958072542705,
                                    0.7610743363017818, 0.8934692482167803,
                                    0.5924616305970842}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-3.8575425138876067, -7.104375564562316,
                                  1.0276201565596548, 2.4944075220821382,
                                  1.8584241390126266, 0.4224281660135798,
                                  -3.491591638266393, 9.701103457837132}},
                  Eigen::ArrayXd{{0.8039261373698234, 0.6284331509962017,
                                  0.9777553399848103, 0.03994408705637864,
                                  0.40372345122014575, 0.9507470901176629,
                                  0.41000390988600466, 0.9826443454037379}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-3.5559184736584193, -7.141822687605044,
                                    1.356611477735635, 2.474807470192315,
                                    1.859009875166473, 0.1768067600139665,
                                    -3.5265449114819183, 10.017731542199149},
                                   {-3.9902450807343355, -7.185523100729362,
                                    0.6109203206489379, 2.504406433649619,
                                    1.8619827868321766, 0.42742095485685544,
                                    -3.6926053857785623, 9.519571443535977},
                                   {-3.8937682380274405, -7.388470391791305,
                                    0.7103780827195894, 2.4850754910024846,
                                    1.7219000999261784, 0.8887313213901633,
                                    -3.326724283774486, 9.341782161215622},
                                   {-3.8163914384120647, -7.233579364360902,
                                    0.6722558433382564, 2.4972349543861827,
                                    1.8429895982074518, 0.03414764574949436,
                                    -3.2982675792369407, 9.494903858545712}},
                   Eigen::ArrayXXd{{0.462516083172089, 0.6336945117800614,
                                    0.38556294481033415, 8.854706567829153,
                                    0.9881562721329916, 0.4058374429928063,
                                    0.9694912565071507, 0.385450111559861},
                                   {0.4895276215784724, 0.6295501427449784,
                                    0.37259715591244863, 9.679452763703335,
                                    0.9881189246390788, 0.41960347147176497,
                                    0.8628334133356212, 0.39911941648917526},
                                   {0.4957389022691982, 0.5731568443854956,
                                    0.38709709168099804, 9.718635466693252,
                                    0.9332424680930742, 0.3720575580180618,
                                    0.8974509199697062, 0.37973298791538235},
                                   {0.49559276039805744, 0.6215444058139328,
                                    0.3819405315655234, 9.962527979049565,
                                    0.9874354456310032, 0.3860360005555895,
                                    0.8706507372252372, 0.3971476159404781}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-2.476366565400343, 1.9665449798929888,
                                  4.32440118718532, -8.54133768818987,
                                  7.182063722449403, 4.583504722173089}},
                  Eigen::ArrayXd{{0.18510831085574886, 0.28801872211245083,
                                  0.9443346131592469, 0.3222591646977824,
                                  0.16683331353025532, 0.43470288020538617}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-2.468859305402574, 1.9314910210110054,
                                    3.9278792709210086, -8.440788996449236,
                                    7.1613509825182735, 4.474366310002076},
                                   {-2.464111308768034, 1.9800718131909631,
                                    4.753804040952419, -8.534818808293792,
                                    7.1998744188692125, 4.690840351577163},
                                   {-2.486669252560147, 1.8626731746430196,
                                    3.930594759709111, -8.59842517029628,
                                    7.10128996976559, 4.4904822778377005}},
                   Eigen::ArrayXXd{{2.1534112910703165, 1.3749054104286649,
                                    0.38681065720351154, 1.1791395224744623,
                                    2.3729043222983304, 0.8892626158815672},
                                   {2.150464831280716, 1.3835994481923788,
                                    0.38096546114005203, 1.2377015424084175,
                                    2.377674667361362, 0.8901813471005361},
                                   {2.151847429813008, 1.297915787363073,
                                    0.3872763864479911, 1.2186820696979097,
                                    2.1267965253017804, 0.8969617476640307}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-3.4918971789018016, -7.496870146411796,
                                  -2.8502515978732372, -3.8105005310179614,
                                  -6.943498040361708, -3.2965131716846185,
                                  8.022294414883074, 10.127904390613612,
                                  -6.042565403860928}},
                  Eigen::ArrayXd{{0.6444416747659548, 0.23800708848091667,
                                  0.1290448884183285, 0.7773368964337845,
                                  0.435015979191278, 0.5770613270515872,
                                  0.14737720707119584, 0.36175921074691053,
                                  0.5103739816516891}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{
                       {-3.79209322938953, -7.529711609563534,
                        -2.851316496705749, -3.626248197598578,
                        -6.978652889290641, -3.2847384806732145,
                        8.06145650664375, 9.96337026408481, -6.010056788056824},
                       {-3.574658677473057, -7.388413010662828,
                        -2.816911516521331, -3.88278926797823,
                        -7.061801009696483, -3.5748612003158864,
                        8.018458195626435, 10.246852601529806,
                        -6.251099291340294},
                       {-3.498498352114687, -7.5150317488969645,
                        -2.85923818599892, -3.668923662124811,
                        -6.849193188904534, -3.1706736102084427,
                        7.969053433409188, 9.990583782057946,
                        -6.1229985623856145}},
                   Eigen::ArrayXXd{{0.5554018776387384, 1.6602967093851628,
                                    3.091394800008437, 0.49900021183991966,
                                    0.9140853137502355, 0.6911903834164888,
                                    2.613044488779781, 0.9944244101748024,
                                    0.7800825136675065},
                                   {0.6139671327996526, 1.5108768881749164,
                                    2.9900239483631954, 0.5110023107662712,
                                    0.8837821765396913, 0.615411179510029,
                                    2.7060300438440668, 1.044754133630875,
                                    0.7190674976307726},
                                   {0.6190185508666083, 1.6713052555693249,
                                    3.084012835764504, 0.5047748037412495,
                                    0.8957769444983094, 0.675090186634537,
                                    2.535949855838576, 1.0261287066643012,
                                    0.7720196015919669}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-9.432618966082405, -6.68631396681345,
                                  -5.167235156636846, 5.029411703710954,
                                  0.9306042422800225}},
                  Eigen::ArrayXd{{0.662527125770597, 0.19592379566920903,
                                  0.33418922958192476, 0.5904823761952287,
                                  0.3569505039309513}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-9.418935724147044, -6.701215981816192,
                                    -5.175721931856057, 5.00521674533934,
                                    1.0810073754211171},
                                   {-9.65925556851413, -6.70728572541164,
                                    -5.218913763286539, 4.962373394354682,
                                    1.008476383186342}},
                   Eigen::ArrayXXd{{0.6020239615862709, 2.0303300745065673,
                                    1.1933767593109548, 0.6750540513715728,
                                    1.0227031825571935},
                                   {0.5679318955900529, 2.0245797288308456,
                                    1.1795733262997996, 0.6712808086353078,
                                    1.0913580475355082}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{0.7509576839875525, -2.710682985887807,
                                  9.639413989311144, -6.634791466041454,
                                  8.371742925227121, -5.903650741497055}},
                  Eigen::ArrayXd{{0.40962659392948586, 0.9016584266443417,
                                  0.7298366390911284, 0.8414879880862584,
                                  0.7724088633643373, 0.5776151522656441}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{0.832156908482153, -2.3767959914263885,
                                    9.728667853005618, -6.901753472411762,
                                    8.741775365833341, -5.630682979432967},
                                   {0.6707437023041374, -2.3203086514565863,
                                    9.818091397653024, -6.36806764099324,
                                    8.420622341955227, -5.832903558014405},
                                   {0.7446230584741775, -2.9988132542005608,
                                    9.558524773780691, -6.696549096969907,
                                    8.488882848957534, -5.760773517796277},
                                   {0.7963599188987576, -2.5736727295791293,
                                    10.004291537293712, -6.425296165324284,
                                    8.380521107312243, -5.730283699557599}},
                   Eigen::ArrayXXd{{0.9549690874113499, 0.4131348419255867,
                                    0.5425463485683213, 0.4508237776368593,
                                    0.46049746995819657, 0.6176979541307057},
                                   {0.9554217434054598, 0.40286953556082666,
                                    0.5304805443828337, 0.45086424396896846,
                                    0.5154579385363963, 0.6855101753999622},
                                   {0.9738004957855416, 0.42043011678386266,
                                    0.5432716317649093, 0.4728164070720793,
                                    0.5105856136831547, 0.6698618054675365},
                                   {0.9679529531099654, 0.43737515736322524,
                                    0.4824026931176486, 0.45962466145733494,
                                    0.5164577172198817, 0.6602518462896994}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{9.027636520260643, 1.629108519461024,
                                  -7.606615842065893, -0.8462679081910274,
                                  -1.5444198938491915, 2.2477767862909754,
                                  -0.6141478609617241, -8.613963258194202,
                                  1.5080554608624208}},
                  Eigen::ArrayXd{{0.8893078289429595, 0.15855134083782085,
                                  0.5008006085574599, 0.5371133504840475,
                                  0.6885159774070596, 0.7784025325013441,
                                  0.009522328408979264, 0.32139254570774034,
                                  0.9080100843834918}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{8.596010641961902, 1.6919275046349,
                                    -7.834457579787726, -1.093972120270151,
                                    -1.6265490137670955, 2.2541226615349697,
                                    -0.6169186327131774, -8.616335815159294,
                                    1.168126685702286}},
                   Eigen::ArrayXXd{{0.3987545629179528, 2.32622948300045,
                                    0.7182889796150019, 0.6678214548624285,
                                    0.5753158148437763, 0.5124970778975265,
                                    40.15888643112935, 1.2412590633210754,
                                    0.40962467436871125}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-7.153784412540276, 9.98487888335421,
                                  -7.3798059895879184, 3.594501888585034,
                                  1.0957802461130566, -3.0336354724572434,
                                  3.112787840554507, 8.275064183777186,
                                  4.448878602933888}},
                  Eigen::ArrayXd{{0.8598801845621697, 0.35080045344368704,
                                  0.89307573991714, 0.5964154250272163,
                                  0.21069784732305574, 0.1774369198536101,
                                  0.11225468360698454, 0.23541966840200312,
                                  0.4957020265393701}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{
                       {-7.193153337405844, 9.894198639656294,
                        -7.700603666413653, 3.5976184241806255,
                        1.1409347386297917, -2.9679156078837527,
                        3.089793441015463, 8.326752007920229,
                        4.244173575563366},
                       {-7.471194574734332, 9.860480678640565,
                        -7.719155409089486, 3.86708877066306, 1.142046242744097,
                        -3.027344125766732, 3.0702085072941436,
                        8.332524942119441, 4.375017542936293},
                       {-6.896085332883796, 10.082723971189608,
                        -7.540080951546384, 3.718349737008115,
                        1.106426355060523, -3.0979170747013343,
                        3.0576829017977767, 8.195290914619344,
                        4.586169102669824},
                       {-7.298401149099769, 9.846807425794506,
                        -7.346084280868412, 3.6791479052610914,
                        1.0730755328843853, -2.9771548487309505,
                        3.083869508566427, 8.241974353391335,
                        4.647413058689274}},
                   Eigen::ArrayXXd{
                       {0.46346499969387117, 1.0998670411992753,
                        0.4187970157127935, 0.6688908721758776,
                        1.8504473481981842, 2.099311186550325,
                        3.4801190690736297, 1.6542447510818055,
                        0.7390230554299227},
                       {0.43339492328778545, 1.0679321423730228,
                        0.4155940200541379, 0.6025621999620395,
                        1.8483307780811906, 2.246948309107889,
                        3.3072215500735935, 1.6448677237666218,
                        0.7959179425130369},
                       {0.44357698166376963, 1.0938473367566934,
                        0.4395699951039495, 0.6546328581036112,
                        1.89101762492741, 2.1055541408934872, 3.150493043260318,
                        1.6000509108481413, 0.7745197242345905},
                       {0.45743568750814795, 1.0524731261250806,
                        0.4463876561482687, 0.6621971250177786,
                        1.8824715682653477, 2.13729227795822, 3.437911326597317,
                        1.6779434341918313, 0.7427742963121959}}})),
      };
  for (auto [mu_std, x_want] : tests) {
    auto [mu, std] = mu_std;
    auto [x, want] = x_want;
    Eigen::ArrayXXd got =
        stats::multivariates::IndependentGaussian(mu, std).pdf(x);
    EXPECT_THAT((got - want).abs().maxCoeff(), testing::DoubleNear(0, 1e-12));
  }
}

TEST_F(GaussianTest, LOGPDF) {
  std::vector<std::array<Eigen::ArrayXd, 4>> tests{
      std::array<Eigen::ArrayXd, 4>({
          Eigen::ArrayXd{{0.25330232072667835, -0.5810752474581407,
                          0.4193234152171857, -0.5605259164456273,
                          1.2604356503220835, 0.043054772373413354,
                          -2.6145772124036895, -0.9784632799002942,
                          0.4747244271156488, -0.26044389557640363}},
          Eigen::ArrayXd{{-0.8899518314300903, -2.4375936299865706,
                          -0.08492383825829136, -0.8831995526207206,
                          0.18378043968932584, -1.129415569361523,
                          -0.02837250181973601, 1.6164352441018535,
                          -0.1846919394052537, 0.445020244888626}},
          Eigen::ArrayXd{{0.2392063282606547, 0.10387697227725928,
                          0.09377033816258806, 1.7721099591823173,
                          1.223080873193922, 1.0385368574760807,
                          0.5369439838648985, 0.26489216162458945,
                          0.970396595539162, 1.213978100876403}},
          Eigen::ArrayXd{{1.8280591781660975e-05, 1.6732643003980243e-69,
                          2.236434213557814e-06, 0.2214215767599463,
                          0.2214055722715615, 0.20310527704292855,
                          6.8139481452575486e-06, 2.1867612112791966e-21,
                          0.32635466736690516, 0.2775677955734867}},
      }),
  };
  for (auto [x, mu, std, want] : tests) {
    Eigen::ArrayXd got =
        stats::multivariates::IndependentGaussian(mu, std).logpdf(x);
    EXPECT_THAT((got - want.log()).abs().maxCoeff(),
                testing::DoubleNear(0, 1e-12));
  }
}

TEST_F(GaussianTest, VECLOGPDF) {
  std::vector<
      std::pair<std::array<Eigen::ArrayXd, 2>, std::array<Eigen::ArrayXXd, 2>>>
      tests{
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-1.7103062942294507, -1.716064098300679,
                                  6.402530540906387, -7.680263957988589,
                                  -4.020510770408912, -3.904215895378364,
                                  -4.690005917453478, 5.800963477438673,
                                  0.19173240302784933}},
                  Eigen::ArrayXd{{0.8699978965814119, 0.07670143113334216,
                                  0.4627251646620222, 0.9570066521439576,
                                  0.40175291200332486, 0.7693691637855942,
                                  0.5451069735456672, 0.2091255842067915,
                                  0.0778885423872866}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-1.5585460906815007, -1.7503633743755496,
                                    6.466263869400677, -7.890425453154885,
                                    -4.17803277405953, -3.6158826273878293,
                                    -4.481227882814776, 5.858757456064997,
                                    0.19047351782790478},
                                   {-2.111517001958209, -1.7340561464946112,
                                    6.3341839061316945, -7.8075181542504675,
                                    -4.114275119469093, -3.672226355264332,
                                    -4.7073394263590975, 5.838289796127166,
                                    0.22891580744248058},
                                   {-1.4580264992607042, -1.7168843835110303,
                                    6.325498388553404, -7.326609865172252,
                                    -3.8579476215423014, -3.9758545986050087,
                                    -4.882361776850502, 5.828559462882013,
                                    0.19526603554383976},
                                   {-1.5727340789790873, -1.7032253666861255,
                                    6.270100139457355, -7.4391111115538,
                                    -4.1497153645146545, -3.6237033794729068,
                                    -4.477440284238644, 5.7938532604310105,
                                    0.22557595840484077}},
                   Eigen::ArrayXXd{{0.45163169837117006, 4.706345996669171,
                                    0.854018891709886, 0.40693316243721933,
                                    0.9195355929030472, 0.4833670980768384,
                                    0.6801028369738207, 1.8361928514130554,
                                    5.121294653695761},
                                   {0.4122976931642753, 5.06008987265828,
                                    0.8528045762287652, 0.4131955757399517,
                                    0.9663245676250993, 0.4954865920529195,
                                    0.7314906216792518, 1.8775221185381379,
                                    4.570333118815116},
                                   {0.43967585501749473, 5.200939031808864,
                                    0.850293673410255, 0.38935092600614485,
                                    0.9149506889357002, 0.516288669362805,
                                    0.6876835561116648, 1.8911312880598647,
                                    5.116695219493937},
                                   {0.45285807797456334, 5.128880314543421,
                                    0.8275623705545849, 0.4038376983906504,
                                    0.9429571159087327, 0.48518695343098905,
                                    0.6782789474156102, 1.9065661589383627,
                                    4.660567734085475}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{0.38210537161640623, -2.622193118001235,
                                  -8.412610696979964, 2.0270668034748365,
                                  4.5953205420409144}},
                  Eigen::ArrayXd{{0.13600731234654784, 0.8020058582110072,
                                  0.7071569921360084, 0.4285141545487946,
                                  0.36420815325195055}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{0.34000638789501597, -2.2960172794392255,
                                    -8.461696926120608, 2.0507549657783404,
                                    4.535757616136808},
                                   {0.37507574198330074, -2.543404054729921,
                                    -8.667285441837727, 2.1798057413659624,
                                    4.543314852025373},
                                   {0.4293100603804343, -2.6832942323019875,
                                    -8.1788176971804, 2.1916020112205996,
                                    4.557033733040164}},
                   Eigen::ArrayXXd{{2.796034676525583, 0.45794708339739454,
                                    0.5627920581551867, 0.9295683403196665,
                                    1.0808182362841172},
                                   {2.9293260800798397, 0.49503603736022883,
                                    0.5287254579726989, 0.8736886322321973,
                                    1.0842587134168538},
                                   {2.76178633139912, 0.4959891279343168,
                                    0.5341453134872773, 0.8648300412864817,
                                    1.0893331549769156}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{5.179569012543167, -1.7131183026963832,
                                  -4.342526692012702, 10.965440239685591,
                                  1.9393778965091393, -4.133950154542898,
                                  -4.704041819763022, 5.25604688725503,
                                  5.616011521684042}},
                  Eigen::ArrayXd{{0.013509284557149837, 0.2647343490164883,
                                  0.29799107940259206, 0.5986030953484324,
                                  0.8920299102299334, 0.09019660696714704,
                                  0.48358421316720057, 0.40632279184920794,
                                  0.6236997874957313}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{5.175310698258331, -1.6777536912079978,
                                    -4.466474289278132, 10.746284448298933,
                                    2.194104169611948, -4.138647940170635,
                                    -4.5960228235993865, 5.282250233498445,
                                    5.763934811427234},
                                   {5.1749503229019, -1.6624299129536848,
                                    -4.375541061987361, 11.088409705968965,
                                    2.114573791980587, -4.146801776012863,
                                    -4.671032685577396, 5.295049310902759,
                                    5.436460521073471},
                                   {5.179647288516721, -1.8079319184191622,
                                    -4.484455065111465, 10.713681693101787,
                                    2.3170321418450266, -4.113148906394696,
                                    -4.509865426438064, 5.432516585705722,
                                    5.8601591512646785}},
                   Eigen::ArrayXXd{{28.099721072888414, 1.493567219864944,
                                    1.2278301367030862, 0.6232540689383451,
                                    0.42936212483259345, 4.417034631138833,
                                    0.8046433271590007, 0.9797963190396934,
                                    0.6218991374505491},
                                   {27.85451737502407, 1.479582144044183,
                                    1.3305814212002056, 0.6525404005891624,
                                    0.4386867532447336, 4.378359080509864,
                                    0.8230499429983807, 0.9773230041775715,
                                    0.6136748904913378},
                                   {29.53047453348969, 1.4133397336223723,
                                    1.1952196625531395, 0.6100438595639662,
                                    0.4088929551126875, 4.306958072542705,
                                    0.7610743363017818, 0.8934692482167803,
                                    0.5924616305970842}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-3.8575425138876067, -7.104375564562316,
                                  1.0276201565596548, 2.4944075220821382,
                                  1.8584241390126266, 0.4224281660135798,
                                  -3.491591638266393, 9.701103457837132}},
                  Eigen::ArrayXd{{0.8039261373698234, 0.6284331509962017,
                                  0.9777553399848103, 0.03994408705637864,
                                  0.40372345122014575, 0.9507470901176629,
                                  0.41000390988600466, 0.9826443454037379}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-3.5559184736584193, -7.141822687605044,
                                    1.356611477735635, 2.474807470192315,
                                    1.859009875166473, 0.1768067600139665,
                                    -3.5265449114819183, 10.017731542199149},
                                   {-3.9902450807343355, -7.185523100729362,
                                    0.6109203206489379, 2.504406433649619,
                                    1.8619827868321766, 0.42742095485685544,
                                    -3.6926053857785623, 9.519571443535977},
                                   {-3.8937682380274405, -7.388470391791305,
                                    0.7103780827195894, 2.4850754910024846,
                                    1.7219000999261784, 0.8887313213901633,
                                    -3.326724283774486, 9.341782161215622},
                                   {-3.8163914384120647, -7.233579364360902,
                                    0.6722558433382564, 2.4972349543861827,
                                    1.8429895982074518, 0.03414764574949436,
                                    -3.2982675792369407, 9.494903858545712}},
                   Eigen::ArrayXXd{{0.462516083172089, 0.6336945117800614,
                                    0.38556294481033415, 8.854706567829153,
                                    0.9881562721329916, 0.4058374429928063,
                                    0.9694912565071507, 0.385450111559861},
                                   {0.4895276215784724, 0.6295501427449784,
                                    0.37259715591244863, 9.679452763703335,
                                    0.9881189246390788, 0.41960347147176497,
                                    0.8628334133356212, 0.39911941648917526},
                                   {0.4957389022691982, 0.5731568443854956,
                                    0.38709709168099804, 9.718635466693252,
                                    0.9332424680930742, 0.3720575580180618,
                                    0.8974509199697062, 0.37973298791538235},
                                   {0.49559276039805744, 0.6215444058139328,
                                    0.3819405315655234, 9.962527979049565,
                                    0.9874354456310032, 0.3860360005555895,
                                    0.8706507372252372, 0.3971476159404781}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-2.476366565400343, 1.9665449798929888,
                                  4.32440118718532, -8.54133768818987,
                                  7.182063722449403, 4.583504722173089}},
                  Eigen::ArrayXd{{0.18510831085574886, 0.28801872211245083,
                                  0.9443346131592469, 0.3222591646977824,
                                  0.16683331353025532, 0.43470288020538617}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-2.468859305402574, 1.9314910210110054,
                                    3.9278792709210086, -8.440788996449236,
                                    7.1613509825182735, 4.474366310002076},
                                   {-2.464111308768034, 1.9800718131909631,
                                    4.753804040952419, -8.534818808293792,
                                    7.1998744188692125, 4.690840351577163},
                                   {-2.486669252560147, 1.8626731746430196,
                                    3.930594759709111, -8.59842517029628,
                                    7.10128996976559, 4.4904822778377005}},
                   Eigen::ArrayXXd{{2.1534112910703165, 1.3749054104286649,
                                    0.38681065720351154, 1.1791395224744623,
                                    2.3729043222983304, 0.8892626158815672},
                                   {2.150464831280716, 1.3835994481923788,
                                    0.38096546114005203, 1.2377015424084175,
                                    2.377674667361362, 0.8901813471005361},
                                   {2.151847429813008, 1.297915787363073,
                                    0.3872763864479911, 1.2186820696979097,
                                    2.1267965253017804, 0.8969617476640307}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-3.4918971789018016, -7.496870146411796,
                                  -2.8502515978732372, -3.8105005310179614,
                                  -6.943498040361708, -3.2965131716846185,
                                  8.022294414883074, 10.127904390613612,
                                  -6.042565403860928}},
                  Eigen::ArrayXd{{0.6444416747659548, 0.23800708848091667,
                                  0.1290448884183285, 0.7773368964337845,
                                  0.435015979191278, 0.5770613270515872,
                                  0.14737720707119584, 0.36175921074691053,
                                  0.5103739816516891}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{
                       {-3.79209322938953, -7.529711609563534,
                        -2.851316496705749, -3.626248197598578,
                        -6.978652889290641, -3.2847384806732145,
                        8.06145650664375, 9.96337026408481, -6.010056788056824},
                       {-3.574658677473057, -7.388413010662828,
                        -2.816911516521331, -3.88278926797823,
                        -7.061801009696483, -3.5748612003158864,
                        8.018458195626435, 10.246852601529806,
                        -6.251099291340294},
                       {-3.498498352114687, -7.5150317488969645,
                        -2.85923818599892, -3.668923662124811,
                        -6.849193188904534, -3.1706736102084427,
                        7.969053433409188, 9.990583782057946,
                        -6.1229985623856145}},
                   Eigen::ArrayXXd{{0.5554018776387384, 1.6602967093851628,
                                    3.091394800008437, 0.49900021183991966,
                                    0.9140853137502355, 0.6911903834164888,
                                    2.613044488779781, 0.9944244101748024,
                                    0.7800825136675065},
                                   {0.6139671327996526, 1.5108768881749164,
                                    2.9900239483631954, 0.5110023107662712,
                                    0.8837821765396913, 0.615411179510029,
                                    2.7060300438440668, 1.044754133630875,
                                    0.7190674976307726},
                                   {0.6190185508666083, 1.6713052555693249,
                                    3.084012835764504, 0.5047748037412495,
                                    0.8957769444983094, 0.675090186634537,
                                    2.535949855838576, 1.0261287066643012,
                                    0.7720196015919669}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-9.432618966082405, -6.68631396681345,
                                  -5.167235156636846, 5.029411703710954,
                                  0.9306042422800225}},
                  Eigen::ArrayXd{{0.662527125770597, 0.19592379566920903,
                                  0.33418922958192476, 0.5904823761952287,
                                  0.3569505039309513}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-9.418935724147044, -6.701215981816192,
                                    -5.175721931856057, 5.00521674533934,
                                    1.0810073754211171},
                                   {-9.65925556851413, -6.70728572541164,
                                    -5.218913763286539, 4.962373394354682,
                                    1.008476383186342}},
                   Eigen::ArrayXXd{{0.6020239615862709, 2.0303300745065673,
                                    1.1933767593109548, 0.6750540513715728,
                                    1.0227031825571935},
                                   {0.5679318955900529, 2.0245797288308456,
                                    1.1795733262997996, 0.6712808086353078,
                                    1.0913580475355082}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{0.7509576839875525, -2.710682985887807,
                                  9.639413989311144, -6.634791466041454,
                                  8.371742925227121, -5.903650741497055}},
                  Eigen::ArrayXd{{0.40962659392948586, 0.9016584266443417,
                                  0.7298366390911284, 0.8414879880862584,
                                  0.7724088633643373, 0.5776151522656441}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{0.832156908482153, -2.3767959914263885,
                                    9.728667853005618, -6.901753472411762,
                                    8.741775365833341, -5.630682979432967},
                                   {0.6707437023041374, -2.3203086514565863,
                                    9.818091397653024, -6.36806764099324,
                                    8.420622341955227, -5.832903558014405},
                                   {0.7446230584741775, -2.9988132542005608,
                                    9.558524773780691, -6.696549096969907,
                                    8.488882848957534, -5.760773517796277},
                                   {0.7963599188987576, -2.5736727295791293,
                                    10.004291537293712, -6.425296165324284,
                                    8.380521107312243, -5.730283699557599}},
                   Eigen::ArrayXXd{{0.9549690874113499, 0.4131348419255867,
                                    0.5425463485683213, 0.4508237776368593,
                                    0.46049746995819657, 0.6176979541307057},
                                   {0.9554217434054598, 0.40286953556082666,
                                    0.5304805443828337, 0.45086424396896846,
                                    0.5154579385363963, 0.6855101753999622},
                                   {0.9738004957855416, 0.42043011678386266,
                                    0.5432716317649093, 0.4728164070720793,
                                    0.5105856136831547, 0.6698618054675365},
                                   {0.9679529531099654, 0.43737515736322524,
                                    0.4824026931176486, 0.45962466145733494,
                                    0.5164577172198817, 0.6602518462896994}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{9.027636520260643, 1.629108519461024,
                                  -7.606615842065893, -0.8462679081910274,
                                  -1.5444198938491915, 2.2477767862909754,
                                  -0.6141478609617241, -8.613963258194202,
                                  1.5080554608624208}},
                  Eigen::ArrayXd{{0.8893078289429595, 0.15855134083782085,
                                  0.5008006085574599, 0.5371133504840475,
                                  0.6885159774070596, 0.7784025325013441,
                                  0.009522328408979264, 0.32139254570774034,
                                  0.9080100843834918}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{8.596010641961902, 1.6919275046349,
                                    -7.834457579787726, -1.093972120270151,
                                    -1.6265490137670955, 2.2541226615349697,
                                    -0.6169186327131774, -8.616335815159294,
                                    1.168126685702286}},
                   Eigen::ArrayXXd{{0.3987545629179528, 2.32622948300045,
                                    0.7182889796150019, 0.6678214548624285,
                                    0.5753158148437763, 0.5124970778975265,
                                    40.15888643112935, 1.2412590633210754,
                                    0.40962467436871125}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-7.153784412540276, 9.98487888335421,
                                  -7.3798059895879184, 3.594501888585034,
                                  1.0957802461130566, -3.0336354724572434,
                                  3.112787840554507, 8.275064183777186,
                                  4.448878602933888}},
                  Eigen::ArrayXd{{0.8598801845621697, 0.35080045344368704,
                                  0.89307573991714, 0.5964154250272163,
                                  0.21069784732305574, 0.1774369198536101,
                                  0.11225468360698454, 0.23541966840200312,
                                  0.4957020265393701}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{
                       {-7.193153337405844, 9.894198639656294,
                        -7.700603666413653, 3.5976184241806255,
                        1.1409347386297917, -2.9679156078837527,
                        3.089793441015463, 8.326752007920229,
                        4.244173575563366},
                       {-7.471194574734332, 9.860480678640565,
                        -7.719155409089486, 3.86708877066306, 1.142046242744097,
                        -3.027344125766732, 3.0702085072941436,
                        8.332524942119441, 4.375017542936293},
                       {-6.896085332883796, 10.082723971189608,
                        -7.540080951546384, 3.718349737008115,
                        1.106426355060523, -3.0979170747013343,
                        3.0576829017977767, 8.195290914619344,
                        4.586169102669824},
                       {-7.298401149099769, 9.846807425794506,
                        -7.346084280868412, 3.6791479052610914,
                        1.0730755328843853, -2.9771548487309505,
                        3.083869508566427, 8.241974353391335,
                        4.647413058689274}},
                   Eigen::ArrayXXd{
                       {0.46346499969387117, 1.0998670411992753,
                        0.4187970157127935, 0.6688908721758776,
                        1.8504473481981842, 2.099311186550325,
                        3.4801190690736297, 1.6542447510818055,
                        0.7390230554299227},
                       {0.43339492328778545, 1.0679321423730228,
                        0.4155940200541379, 0.6025621999620395,
                        1.8483307780811906, 2.246948309107889,
                        3.3072215500735935, 1.6448677237666218,
                        0.7959179425130369},
                       {0.44357698166376963, 1.0938473367566934,
                        0.4395699951039495, 0.6546328581036112,
                        1.89101762492741, 2.1055541408934872, 3.150493043260318,
                        1.6000509108481413, 0.7745197242345905},
                       {0.45743568750814795, 1.0524731261250806,
                        0.4463876561482687, 0.6621971250177786,
                        1.8824715682653477, 2.13729227795822, 3.437911326597317,
                        1.6779434341918313, 0.7427742963121959}}})),
      };
  for (auto [mu_std, x_want] : tests) {
    auto [mu, std] = mu_std;
    auto [x, want] = x_want;
    Eigen::ArrayXXd got =
        stats::multivariates::IndependentGaussian(mu, std).logpdf(x);
    EXPECT_THAT((got - want.log()).abs().maxCoeff(),
                testing::DoubleNear(0, 1e-12));
  }
}

TEST_F(GaussianTest, CDF) {
  std::vector<std::array<Eigen::ArrayXd, 4>> tests{
      std::array<Eigen::ArrayXd, 4>({
          Eigen::ArrayXd{{0.25330232072667835, -0.5810752474581407,
                          0.4193234152171857, -0.5605259164456273,
                          1.2604356503220835, 0.043054772373413354,
                          -2.6145772124036895, -0.9784632799002942,
                          0.4747244271156488, -0.26044389557640363}},
          Eigen::ArrayXd{{-0.8899518314300903, -2.4375936299865706,
                          -0.08492383825829136, -0.8831995526207206,
                          0.18378043968932584, -1.129415569361523,
                          -0.02837250181973601, 1.6164352441018535,
                          -0.1846919394052537, 0.445020244888626}},
          Eigen::ArrayXd{{0.2392063282606547, 0.10387697227725928,
                          0.09377033816258806, 1.7721099591823173,
                          1.223080873193922, 1.0385368574760807,
                          0.5369439838648985, 0.26489216162458945,
                          0.970396595539162, 1.213978100876403}},
          Eigen::ArrayXd{{9.999991207478258e-01, 1.000000000000000e+00,
                          9.999999622302661e-01, 5.722417671984571e-01,
                          8.106465275189283e-01, 8.705434119601626e-01,
                          7.303953400302935e-07, 5.853367505663225e-23,
                          7.515998504403645e-01, 2.805805710127949e-01}},
      }),
  };
  for (auto [x, mu, std, want] : tests) {
    Eigen::ArrayXd got =
        stats::multivariates::IndependentGaussian(mu, std).cdf(x);
    EXPECT_THAT((got - want).abs().maxCoeff(), testing::DoubleNear(0, 1e-12));
  }
}

TEST_F(GaussianTest, VECCDF) {
  std::vector<
      std::pair<std::array<Eigen::ArrayXd, 2>, std::array<Eigen::ArrayXXd, 2>>>
      tests{
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-4.481621705386679, 0.9313834293997285,
                                  3.1711434014071447, 1.4376505172831315,
                                  10.005117113484996}},
                  Eigen::ArrayXd{{0.9610144569088885, 0.5747449212623231,
                                  0.271669446185568, 0.6497147454666892,
                                  0.20846870986918487}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-4.012877194071397, 1.214283067822454,
                                    3.1285924446603057, 1.5713793015851207,
                                    10.015568739969494},
                                   {-4.337944397033858, 0.9861917633018952,
                                    3.2347049940568198, 1.32734517433836,
                                    10.00104066333382}},
                   Eigen::ArrayXXd{{0.6871401132191608, 0.6887172828017624,
                                    0.4377691407366289, 0.5815369434768861,
                                    0.5199926867819945},
                                   {0.5594227635003302, 0.5379860114954181,
                                    0.5924945686638349, 0.43259353095922315,
                                    0.49219947834302163}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-9.135839501737346, -9.67826786733274,
                                  1.0934473611804076, -5.86431284478463,
                                  -4.464440738787038}},
                  Eigen::ArrayXd{{0.2098091930585152, 0.3335049101394735,
                                  0.5275967072748334, 0.7657341246958248,
                                  0.5871887756574813}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-9.205120523037905, -9.641621762828942,
                                    1.3389272662846443, -5.634095530816131,
                                    -4.658968293213731},
                                   {-9.215175792178574, -9.520692111732844,
                                    0.8886629635353548, -5.589174903565895,
                                    -4.539616004736823},
                                   {-9.129749002085962, -9.580533909685995,
                                    1.0163091167745946, -6.035635375551763,
                                    -4.544391379658013}},
                   Eigen::ArrayXXd{{0.3706207759182594, 0.5437484234576037,
                                    0.6791343249751651, 0.6181589760920989,
                                    0.3702141466184123},
                                   {0.3526649930090169, 0.6817093433841521,
                                    0.3489541040022226, 0.6403193860116275,
                                    0.4490643093402984},
                                   {0.5115791714397534, 0.6152584269165603,
                                    0.44187905523795556, 0.41148124372199396,
                                    0.4458480595704938}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{4.6403754786411024, 2.0526294509867924,
                                  4.951083364313897, -4.0291159416755935,
                                  9.683748453743991, 5.351479343054951}},
                  Eigen::ArrayXd{{0.1360214871811669, 0.022773872543869977,
                                  0.7617192983391076, 0.21175471994616735,
                                  0.3955209375143599, 0.19992415523326845}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{4.615233850078087, 2.052836788593734,
                                    5.260325096475978, -4.108897591157238,
                                    9.803994388945453, 5.301084293318117},
                                   {4.601747708227045, 2.0523121646625033,
                                    5.297333102022677, -4.0342203732883615,
                                    9.727347315497836, 5.307526853906489},
                                   {4.6006598936440115, 2.04775717345238,
                                    4.883693928624053, -4.045705967155212,
                                    9.727111656491335, 5.333173754295078}},
                   Eigen::ArrayXXd{
                       {0.4266789477768223, 0.5036319951696913,
                        0.6576208367644157, 0.3531743329208359,
                        0.6194433452794494, 0.4004931543403917},
                       {0.38821175944976344, 0.4944421031264214,
                        0.6752883257954094, 0.4903842691544312,
                        0.5438871049677011, 0.41299561799819284},
                       {0.3851508702432854, 0.4152963200139965,
                        0.4647514961874849, 0.46877661983403013,
                        0.5436508394653676, 0.46352275729166065}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-3.727471585756933, -0.5958944617033275}},
                  Eigen::ArrayXd{{0.3254603970509582, 0.16228741438965089}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-3.8871432619050106, -0.6749268400951506},
                                   {-3.8783968190615568, -0.6584981681249104}},
                   Eigen::ArrayXXd{
                       {0.3118538179569631, 0.3131326422934809},
                       {0.3214211690498553, 0.34983786489426116}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{9.903566996606159, 7.071159828784168,
                                  -5.5405455402807675, 4.356616666676848,
                                  2.906179628017224, 4.464582032999095}},
                  Eigen::ArrayXd{{0.0519854755142416, 0.8156859656568594,
                                  0.6000059701546774, 0.4073460277794486,
                                  0.5370528750259959, 0.5810320743037312}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{9.889122432317182, 6.928816348605176,
                                    -5.581518607875869, 4.387346226509034,
                                    2.8566926068587164, 4.669291790005197}},
                   Eigen::ArrayXXd{{0.39056080083804273, 0.43073324072055325,
                                    0.47277828115324455, 0.5300670728832296,
                                    0.46329120777608823,
                                    0.6377012009042224}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{1.6962412803435747, -9.021161653333994,
                                  7.553015772964816, 4.920741091828475,
                                  -4.9554967094758355, -9.98529680900486,
                                  -3.7984234163621595}},
                  Eigen::ArrayXd{{0.3091303583107362, 0.16398263011823033,
                                  0.8337081841559143, 0.22958469314197927,
                                  0.10174791486737433, 0.45923471129637705,
                                  0.9688460266924349}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{
                       {1.693201678017563, -8.945996919789382,
                        7.308463794414489, 5.031379679847722, -4.9958558822516,
                        -9.778833607265765, -3.8687203228514266},
                       {1.7238374382826127, -9.01632233983415,
                        7.450772426822554, 4.9225790124334186,
                        -4.931379063628586, -9.84681092683996,
                        -3.815070225259168},
                       {1.7584132715255343, -8.965938366307425,
                        7.743611374135858, 4.86608913369574, -4.973763479090821,
                        -9.932002094714765, -4.136275276316693},
                       {1.6191056967295925, -9.002448581338987,
                        7.426652094105304, 4.81335571591863,
                        -4.9249959906072505, -10.162952067213558,
                        -4.271672118764016}},
                   Eigen::ArrayXXd{{0.49607736247482676, 0.676656713146245,
                                    0.3846347988898584, 0.6850641748773681,
                                    0.34580966264089985, 0.6734937054620955,
                                    0.4710791809333873},
                                   {0.5355664490873883, 0.5117715307320596,
                                    0.4511973360081539, 0.5031936641582029,
                                    0.5936845286233914, 0.6185054696293858,
                                    0.49314567127879966},
                                   {0.5796972405111666, 0.6318522268882517,
                                    0.5904147076248709, 0.40592230246470873,
                                    0.42876091110227443, 0.5461939963182217,
                                    0.3636513628682479},
                                   {0.40147756404034807, 0.5454271534808515,
                                    0.43976374392940315, 0.31998615169586475,
                                    0.6178227494236977, 0.3494333794148007,
                                    0.31260977016488034}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-5.196006655225836, -2.0592651017848214,
                                  9.519229356013142, 2.3906858670237465,
                                  -0.8924849465751983, -3.8457285717552576,
                                  2.945492059998333, -9.437104458475325}},
                  Eigen::ArrayXd{{0.5715709897039909, 0.9409259108186667,
                                  0.4008859197047143, 0.060170962959630536,
                                  0.6203753800586007, 0.9168302527672069,
                                  0.1034874924086363, 0.07775718561526457}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{-5.039112421110723, -1.9287541182097887,
                                    9.334737574305997, 2.378918504774665,
                                    -0.8496698458014806, -3.64500008318295,
                                    2.9566616216432258, -9.45704974290705},
                                   {-5.333472899648969, -2.0062321973745814,
                                    9.544868031327603, 2.373052901439929,
                                    -1.039592176450781, -4.168892858371124,
                                    2.9095303273149757, -9.437058398467144},
                                   {-5.467515025067415, -1.6760818895404423,
                                    9.32522195638505, 2.3854244984983004,
                                    -0.6200224574539894, -3.7975436293667406,
                                    2.9159589842996394, -9.470753785539225},
                                   {-5.433864309853652, -2.1071406024185535,
                                    9.406607683448529, 2.3646789046394487,
                                    -0.7109369510991537, -3.6952907340876444,
                                    2.971145813208434, -9.443023256654817}},
                   Eigen::ArrayXXd{
                       {0.6081484521350233, 0.5551583057243276,
                        0.32268268194168104, 0.42247514726429736,
                        0.5275110920975509, 0.5866506180490443,
                        0.542974990363071, 0.3987795786716279},
                       {0.40496901165476246, 0.5224734712984449,
                        0.5254969871032336, 0.38474282513384644,
                        0.4062794602447393, 0.3622391741957927,
                        0.3641084795719956, 0.5002363162128229},
                       {0.31738591115431547, 0.6580843495617984,
                        0.314211864377696, 0.4651607589040506,
                        0.6697379632058801, 0.5209571673505871,
                        0.38767719850026194, 0.3325986444895492},
                       {0.33865115451627836, 0.47971006725860604,
                        0.38938128824598284, 0.3327915547959952,
                        0.6151021602368705, 0.5651677757855301,
                        0.5978911337430267, 0.46966221737135067}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{9.6236151475522, 0.07564578987292947,
                                  -5.389992636907128, -4.7504760555088446,
                                  5.954608025715736, 8.808885374248426,
                                  -6.14874098559057}},
                  Eigen::ArrayXd{{0.9667221126603296, 0.7242692542557229,
                                  0.7824846085279357, 0.3783652433571796,
                                  0.512922784385093, 0.4694466608546666,
                                  0.026691846509715123}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{9.276609604730425, 0.11464947682584498,
                                    -5.438712178127977, -4.847732552824605,
                                    5.95339273904976, 8.913926760105142,
                                    -6.153854659948949},
                                   {9.78973598714887, 0.1874465527861799,
                                    -5.137353976543446, -4.644707953977572,
                                    5.7795903473523955, 8.662768043743075,
                                    -6.140532734485307}},
                   Eigen::ArrayXXd{{0.35981599923693247, 0.5214736467057031,
                                    0.4751768481206404, 0.39857242206441357,
                                    0.4990547723848365, 0.5885263151656077,
                                    0.42403486534787216},
                                   {0.5682180612484011, 0.5613384483620609,
                                    0.6266021133086597, 0.610084657048134,
                                    0.3664703298759412, 0.3778036217673415,
                                    0.6207758348591638}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{10.669268233938354, -0.2861133716654365,
                                  8.573728663461676, 7.301885535415561,
                                  5.481568296746735, -0.4989151735914241}},
                  Eigen::ArrayXd{{0.2507018466758455, 0.075515091281396,
                                  0.04852783584310416, 0.9010241457768587,
                                  0.05317628548553022, 0.38635934444202047}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{{10.552408747553192, -0.32071734734207746,
                                    8.558804343706921, 6.865664463307825,
                                    5.475744838498475, -0.643499677397716},
                                   {10.557021940494458, -0.3208659701189117,
                                    8.582164825036603, 7.039184394526075,
                                    5.490895179310226, -0.6781463345858081},
                                   {10.691985159551821, -0.2919105723268057,
                                    8.587671465306897, 7.6601568849001875,
                                    5.471979714680597, -0.3091452847160818}},
                   Eigen::ArrayXXd{{0.32056146149267317, 0.3233902968014555,
                                    0.37921564883043835, 0.3141435559960877,
                                    0.4563980763726942, 0.3541192541214354},
                                   {0.3271746736122275, 0.3226837054543944,
                                    0.5690050650355467, 0.38531215040677746,
                                    0.569615572084623, 0.32136056698450255},
                                   {0.5361000745221636, 0.469403747730595,
                                    0.61306464139409, 0.6545473494637164,
                                    0.4284519009626875, 0.6883485119796673}}})),
          std::pair<std::array<Eigen::ArrayXd, 2>,
                    std::array<Eigen::ArrayXXd, 2>>(
              std::array<Eigen::ArrayXd, 2>({
                  Eigen::ArrayXd{{-7.299233773026002, -4.5183089606030205,
                                  6.0723136447472505, 10.824000891099274,
                                  7.431320374000794, 1.7896517204874662,
                                  -4.359313997480655}},
                  Eigen::ArrayXd{{0.18186201567657578, 0.07509480080511577,
                                  0.5238087571382775, 0.043891772478631186,
                                  0.40041561823355765, 0.7506248660867471,
                                  0.6161480927744662}},
              }),
              std::array<Eigen::ArrayXXd, 2>(
                  {Eigen::ArrayXXd{
                       {-7.252030283106943, -4.526972635609181,
                        6.30695534475639, 10.826310318142088, 7.25023847488313,
                        1.8454345421339264, -4.593273223066022},
                       {-7.334281001927147, -4.533678751736612,
                        5.917061361090865, 10.84026942255638, 7.476585041505448,
                        1.728717848592122, -4.404244664387692},
                       {-7.353978643983829, -4.533068951188876,
                        6.11948061781197, 10.810643266677555, 7.62022352117773,
                        1.930309917276373, -4.38662688663497},
                       {-7.382740023597986, -4.506703021152426,
                        5.892122713406715, 10.808908902347058,
                        7.565224019804391, 1.6948551617765901,
                        -4.487767638478053}},
                   Eigen::ArrayXXd{{0.6023970986841537, 0.45407599252964814,
                                    0.6729064386497907, 0.5209812249869188,
                                    0.3255499004311291, 0.5296202005246697,
                                    0.35207936417208685},
                                   {0.42359175401817556, 0.41891426112220076,
                                    0.3834656888435594, 0.6445512723200973,
                                    0.5450022476080353, 0.46765038486172894,
                                    0.4709341479867422},
                                   {0.3816980138196811, 0.42208929061773226,
                                    0.53587473777508, 0.3804378874249183,
                                    0.6814536886478175, 0.5743218392261895,
                                    0.4823212975662061},
                                   {0.3230547256370633, 0.5614121541784793,
                                    0.3654226269857819, 0.3654812374953569,
                                    0.630965523564598, 0.4497511097409032,
                                    0.4174276773052816}}})),
      };
  for (auto [mu_std, x_want] : tests) {
    auto [mu, std] = mu_std;
    auto [x, want] = x_want;
    Eigen::ArrayXXd got =
        stats::multivariates::IndependentGaussian(mu, std).cdf(x);
    EXPECT_THAT((got - want).abs().maxCoeff(), testing::DoubleNear(0, 1e-12));
  }
}

int main(int argc, char **argv) {
  ::testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
